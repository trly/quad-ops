# Cross-Project Dependencies Example - Application Project
#
# This application depends on services in the infrastructure project.
# The infrastructure project must be deployed FIRST.
#
# Deploy infrastructure first:
#   cd examples/cross-project-deps/infrastructure
#   quad-ops up
#
# Then deploy this project:
#   cd examples/cross-project-deps/app
#   quad-ops up
#
# This creates:
#   - app-backend.service (depends on infrastructure-proxy and infrastructure-db)
#   - app-redis.service (intra-project dependency)
#
# The backend service will:
#   1. Wait for infrastructure-proxy to be running (required dependency)
#   2. Wait for infrastructure-db to be running (required dependency)
#   3. Wait for app-redis to be running (intra-project dependency)

name: app

services:
  backend:
    image: docker.io/library/node:18
    # Cross-project dependencies on infrastructure services
    x-quad-ops-depends-on:
      - project: infrastructure
        service: proxy
        optional: false  # Deployment fails if proxy doesn't exist
      - project: infrastructure
        service: db
        optional: false  # Deployment fails if db doesn't exist
    # Intra-project dependency (standard depends_on)
    depends_on:
      - redis
    environment:
      DATABASE_URL: postgresql://postgres:example@infrastructure-db:5432/appdb
      REDIS_URL: redis://redis:6379
      PROXY_URL: http://infrastructure-proxy
    command: ["node", "server.js"]
    restart: always

  redis:
    image: docker.io/library/redis:latest
    restart: always
