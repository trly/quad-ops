# v0.22.0 Final Feature Parity Review

**Date**: 2025-11-09  
**Scope**: Complete feature comparison between v0.21.2 and v0.22.0  
**Epic**: quad-ops-hlf (complete - 15 regressions fixed)

## Executive Summary

‚úÖ **Core Pipeline**: All 15 regressions from epic quad-ops-hlf fixed  
‚ö†Ô∏è **Remaining Gaps**: 10 categories of features need attention  
üìä **Compose Coverage**: ~60% of standard fields, ~40% of advanced fields

---

## What Was Fixed (Epic quad-ops-hlf)

### Critical Fixes (P0-P1)
- ‚úÖ Over-broad volume dependencies (quad-ops-iaa)
- ‚úÖ Missing network dependencies (quad-ops-p22)
- ‚úÖ External networks misclassified (quad-ops-lpb)
- ‚úÖ network-online.target missing (quad-ops-i12)
- ‚úÖ RequiresMountsFor for bind mounts (quad-ops-581)
- ‚úÖ depends_on conditions parsing (quad-ops-gwj)
- ‚úÖ Name normalization (quad-ops-ksi)

### Feature Restoration (P2)
- ‚úÖ Init containers (volumes/networks/env) (quad-ops-1wy)
- ‚úÖ extra_hosts support (quad-ops-h0f)
- ‚úÖ dns/dns_search/dns_opt (quad-ops-4i2)
- ‚úÖ devices mapping (quad-ops-167)
- ‚úÖ Resource constraints (memory/cpu/pids) (quad-ops-5re)

### Mount Options (P3)
- ‚úÖ Volume nocopy flag (quad-ops-xru)
- ‚úÖ Bind mount z/Z SELinux relabel (quad-ops-rqe)
- ‚úÖ Tmpfs size/mode options (quad-ops-d4k)

---

## Remaining Feature Gaps

### 1. Cross-Platform Parity (systemd vs launchd)

**Issue**: Several Compose features work on systemd but NOT on launchd

| Feature | systemd | launchd | Impact |
|---------|---------|---------|--------|
| extra_hosts | ‚úÖ AddHost= | ‚ùå Missing --add-host | macOS users can't add hosts |
| dns/dns_search/dns_opt | ‚úÖ Quadlet directives | ‚ùå Missing --dns flags | macOS DNS broken |
| devices | ‚úÖ AddDevice= | ‚ùå Missing --device | macOS device mapping broken |
| stop_signal/stop_timeout | ‚ùå Not rendered | ‚ùå Missing --stop-signal | Both platforms broken |
| tmpfs long syntax | ‚úÖ Tmpfs= directive | ‚ùå Short syntax only | macOS tmpfs options ignored |

**Root Cause**: `internal/platform/launchd/podmanargs.go` doesn't translate these Container fields to podman CLI flags

**Fix Location**: Add flag generation in `BuildPodmanArgs()`

**Effort**: M (1-3 hours)

---

### 2. Stop Behavior (Both Platforms)

**Fields**: `stop_signal`, `stop_grace_period`

**Status**: Parsed by reader, converted to spec, but NEVER rendered

**Impact**: 
- Containers always get default SIGTERM + 10s timeout
- Custom stop signals (SIGQUIT, etc.) ignored
- Grace periods ignored (may cause data loss on hard kill)

**Fix**:
- systemd: Map to `[Service] StopSignal=` and `StopTimeoutSec=`
- launchd: Add `--stop-signal` and `--stop-timeout` to podman args

**Evidence**: `internal/compose/testdata/golden/*/compose.yml` references these fields

**Effort**: S (<1 hour)

---

### 3. Additional Groups (`group_add`)

**Field**: `group_add` (list of additional GIDs)

**Status**: NOT converted

**Impact**: Containers requiring supplementary group access (e.g., docker socket, audio devices) fail

**Example**:
```yaml
services:
  app:
    group_add:
      - docker  # Access to /var/run/docker.sock
      - audio   # Access to /dev/snd/*
```

**Fix**:
- Add `GroupAdd []string` to `service.Container`
- Convert in `spec_converter.go:convertSecurity()`
- Render as `PodmanArgs=--group-add <gid>` (both platforms)

**Evidence**: `internal/compose/testdata/golden/security-and-user/compose.yml` uses group_add

**Effort**: S (<1 hour)

---

### 4. Shared Memory Size (`shm_size`)

**Field**: `shm_size` (size of `/dev/shm`)

**Status**: NOT converted

**Impact**: Applications using large shared memory (Chrome, PostgreSQL, NumPy) fail with ENOSPC

**Default**: 64MB (often too small)

**Fix**:
- systemd: Map to Quadlet `ShmSize=` directive
- launchd: Add `--shm-size` to podman args

**Effort**: S (<1 hour)

---

### 5. Namespace Modes (PID/IPC/CGroup)

**Fields**: `pid`, `ipc`, `cgroup`

**Status**: NOT converted

**Impact**: Cannot share namespaces or use host modes

**Examples**:
```yaml
services:
  strace:
    pid: "service:app"  # Debug another service
  chrome:
    ipc: "shareable"    # IPC for X11 forwarding
  monitoring:
    pid: "host"         # See all host processes
```

**Fix**:
- Add `PidMode`, `IpcMode`, `CgroupMode` to `service.Container`
- systemd: Quadlet `Pid=`, `Ipc=`, or fallback to PodmanArgs
- launchd: `--pid`, `--ipc`, `--cgroupns` flags

**Effort**: M (1-3 hours)

---

### 6. Device Cgroup Rules (`device_cgroup_rules`)

**Field**: `device_cgroup_rules` (low-level cgroup device permissions)

**Status**: NOT converted

**Impact**: Fine-grained device access control unavailable

**Example**:
```yaml
services:
  udev:
    device_cgroup_rules:
      - 'c 13:* rmw'  # All /dev/input/* devices
```

**Fix**:
- Add `DeviceCgroupRules []string` to `service.Container`
- Render as `PodmanArgs=--device-cgroup-rule <rule>`

**Effort**: S (<1 hour)

---

### 7. Configs (Swarm Configs)

**Field**: `configs` (top-level configs, service-level mounts)

**Status**: Parsed but NEVER mounted or validated

**Risk**: **Silent no-op** - users think configs are mounted but they're not

**Impact**: 
- Swarm migrations fail
- Config-based secrets/certificates ignored

**v0.21.2 Status**: Likely didn't support this either

**Fix Options**:
1. **Map to bind mounts**: Expand configs to host files + bind mounts
2. **Fail validation**: Error when configs present with "unsupported" message
3. **Document as unsupported**: Update README to list as non-goal

**Effort**: M (if implementing), S (if failing validation)

---

### 8. Quad-Ops Extensions (Documented but Not Implemented)

**Extensions**: `x-podman-buildargs`, `x-podman-volumes`

**Status**: Documented in README but NOT wired up

**Evidence**: `grep -r "x-podman-" internal/` finds nothing

**Impact**: Documentation promises features that don't work

**Fix Options**:
1. **Implement**:
   - `x-podman-buildargs`: Add to `build.PodmanArgs` (already exists)
   - `x-podman-volumes`: Add to `service.Mounts` or `Container.PodmanArgs`
2. **Remove from docs** until implemented

**Effort**: M (1-3 hours to implement)

---

### 9. Minor Polish Items

#### Entrypoint/Exec Escaping

**Issue**: Complex entrypoints with quotes/special chars may break

**Status**: No escaping/quoting helper

**Fix**: Document limitation OR add shell-quote helper

**Effort**: S (<1 hour)

---

### 10. Validation Warnings for Silent Ignores

**Issue**: Some Compose fields are parsed but silently ignored (no warning)

**Risk**: Users don't know features aren't working

**Fields at Risk**:
- `stop_signal`, `stop_grace_period`
- `group_add`
- `shm_size`
- `pid`, `ipc`, `cgroup`
- `device_cgroup_rules`
- `configs`
- Extensions (`x-podman-*`)

**Fix**: Add warnings in `cmd/validate.go` when encountering unimplemented fields

**Effort**: S (<1 hour)

---

## Compose Specification Coverage

### Standard Fields (60% coverage)

‚úÖ **Supported**:
- Core: image, container_name, command, entrypoint, working_dir, user, hostname
- Environment: environment, env_file, labels
- Networking: network_mode, networks, ports, expose, dns*, extra_hosts
- Volumes: volumes, tmpfs (with options)
- Resources: mem_limit, cpus, cpu_shares/quota/period, pids_limit
- Security: cap_add, cap_drop, privileged, security_opt, read_only
- Devices: devices
- Health: healthcheck, restart
- Dependencies: depends_on (with conditions)
- Secrets: secrets
- Lifecycle: init containers (quad-ops extension)

‚ö†Ô∏è **Partially Supported**:
- stop_signal/stop_grace_period: Parsed but not rendered
- shm_size: Not converted
- group_add: Not converted
- Namespace modes (pid/ipc/cgroup): Not converted

‚ùå **Not Supported**:
- configs (Swarm)
- volumes_from
- blkio_config
- device_cgroup_rules
- sysctls, ulimits
- logging (driver/options)
- stdin_open, tty
- Extensions (x-podman-*)

### Advanced/Edge Fields (40% coverage)

‚ùå **Not Planned** (Swarm/orchestrator-specific):
- deploy.placement, deploy.update_config, deploy.rollback_config
- deploy.endpoint_mode
- external_links, links (legacy)
- credential_spec (Windows)
- isolation (Windows)

‚ùå **Not Planned** (Modern features):
- develop (watch mode)
- models (AI/ML)
- provider (external services)
- post_start, pre_stop lifecycle hooks

---

## Recommended Implementation Order

### Phase 1: Platform Parity (Critical)
**Goal**: Same Compose file works on systemd + launchd

1. ‚úÖ Add launchd support for:
   - extra_hosts (--add-host)
   - dns/dns_search/dns_opt (--dns flags)
   - devices (--device)
   - tmpfs long syntax (--tmpfs)
2. ‚úÖ Fix stop behavior on BOTH platforms:
   - systemd: StopSignal=, StopTimeoutSec=
   - launchd: --stop-signal, --stop-timeout

**Effort**: M (1-3 hours)  
**Impact**: ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (breaks cross-platform workflows)

### Phase 2: Common Compose Features (High Priority)
**Goal**: Support fields present in 60%+ of real Compose files

1. ‚úÖ group_add (security)
2. ‚úÖ shm_size (stability)
3. ‚úÖ Namespace modes (pid/ipc/cgroup) (debugging/advanced)
4. ‚úÖ device_cgroup_rules (edge case but critical when needed)

**Effort**: S-M (2-4 hours total)  
**Impact**: ‚≠ê‚≠ê‚≠ê‚≠ê (prevents common failures)

### Phase 3: Polish & Safety (Medium Priority)
**Goal**: Users know when features don't work

1. ‚úÖ Validation warnings for unimplemented fields
2. ‚úÖ Document Compose coverage in README
3. ‚úÖ Decide on configs (implement or fail validation)
4. ‚úÖ Fix or remove x-podman-* extensions from docs

**Effort**: S-M (2-3 hours)  
**Impact**: ‚≠ê‚≠ê‚≠ê (improves UX, prevents confusion)

### Phase 4: Advanced Features (Future)
**Goal**: Feature requests from users

1. ‚è∏Ô∏è volumes_from (if requested)
2. ‚è∏Ô∏è logging driver/options (if requested)
3. ‚è∏Ô∏è sysctls, ulimits (if requested)
4. ‚è∏Ô∏è stdin_open, tty (if requested)

**Effort**: M-L (varies by feature)  
**Impact**: ‚≠ê‚≠ê (nice-to-have)

---

## Code Pointers (Quick Reference)

### Conversion Gaps
- **File**: `internal/compose/spec_converter.go`
- **Functions**: 
  - `convertSecurity()` - add group_add, namespace modes
  - `convertResources()` - add shm_size
  - `convertContainer()` - add device_cgroup_rules
  - `convertService()` - add stop_signal/stop_grace_period

### Systemd Renderer
- **File**: `internal/platform/systemd/renderer.go`
- **Sections**:
  - `[Service]` - add StopSignal=, StopTimeoutSec=
  - `addResources()` or new helper - add ShmSize=
  - `addAdvanced()` or `addSecurity()` - add namespace PodmanArgs
  - Container section - add group_add via PodmanArgs

### Launchd Renderer
- **File**: `internal/platform/launchd/podmanargs.go`
- **Function**: `BuildPodmanArgs()`
- **Add flags**:
  - --add-host (from Container.AddHost)
  - --dns, --dns-search, --dns-opt (from Container.DNS*)
  - --device (from Container.Devices)
  - --stop-signal, --stop-timeout (from Container.StopSignal/StopTimeout)
  - --tmpfs with options (from Mount.TmpfsOptions)
  - --shm-size (from Container.ShmSize)
  - --group-add (from Container.GroupAdd)
  - --pid, --ipc, --cgroupns (from Container.*Mode)

### Validation
- **File**: `cmd/validate.go`
- **Add warnings** for:
  - stop_signal/stop_grace_period (if not rendered yet)
  - configs (if not implemented)
  - x-podman-* extensions (if not implemented)
  - Any other unimplemented fields

---

## Testing Strategy

### Integration Tests
1. **Cross-platform**: Same compose file ‚Üí systemd + launchd ‚Üí verify parity
2. **Stop behavior**: Test custom stop signals + grace periods
3. **Namespace modes**: Test pid/ipc sharing scenarios
4. **Device access**: Test group_add + device_cgroup_rules

### Golden Files
- Add compose files exercising ALL new fields
- Verify rendered Quadlet units match expectations
- Check launchd plist includes all podman flags

### Manual Testing
- Real-world Compose files from:
  - Awesome-Compose repository
  - Popular stacks (Nextcloud, GitLab, etc.)
  - User-reported failures

---

## Risk Assessment

### High Risk
- ‚ö†Ô∏è **Silent ignores** (configs, stop_signal, etc.) - users don't know features missing
- ‚ö†Ô∏è **Platform parity** - same file behaves differently on macOS vs Linux

### Medium Risk
- ‚ö†Ô∏è **Documentation promises** (x-podman-*) - documented but not implemented
- ‚ö†Ô∏è **Escaping/quoting** - complex entrypoints may break

### Low Risk
- ‚ÑπÔ∏è Advanced fields (sysctls, ulimits, logging) - edge cases, users can work around

---

## Conclusion

**Epic quad-ops-hlf**: ‚úÖ Complete - 15 regressions fixed  
**Remaining work**: ~10 categories, mostly small fixes  
**Estimated effort**: M-L (1-3 days with tests)  
**Biggest wins**: Platform parity + stop behavior + validation warnings

**Next Steps**:
1. File bd issues for Phase 1-3 gaps
2. Prioritize cross-platform parity (launchd)
3. Add validation warnings to prevent silent failures
4. Update README with Compose coverage matrix
