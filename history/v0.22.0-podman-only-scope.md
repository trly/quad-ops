# v0.22.0 Podman/Quadlet Scope Clarification

**Date**: 2025-11-09  
**Purpose**: Define clear boundaries - Podman/Quadlet features vs Docker Swarm orchestration

## Scope: Podman + Quadlet ONLY

quad-ops converts **standard Docker Compose** to **Podman Quadlet** systemd/launchd units.

**Runtime**: Podman (NOT Docker Engine)  
**Orchestration**: systemd/launchd (NOT Docker Swarm/Kubernetes/Nomad)  
**Compose Library**: github.com/compose-spec/compose-go (standard Compose v2)

---

## In Scope: Standard Compose Features

### ✅ Container Runtime Features (Podman-compatible)

All features that work with standalone Podman containers:

**Core Container Config**:
- image, build, command, entrypoint, working_dir, user, hostname, domainname

**Environment**:
- environment, env_file, labels, annotations

**Networking** (non-orchestrated):
- networks (bridge, host, custom), ports (host mode), expose
- dns, dns_search, dns_opt, extra_hosts
- network_mode (bridge, host, none, container:, service:)

**Storage**:
- volumes (bind, named volume, tmpfs)
- secrets with local sources (file, content, environment)
- configs with local sources (file, content, environment)

**Resources** (cgroup limits):
- memory, cpu (shares/quota/period), pids_limit, shm_size
- blkio_config (if Podman supports)
- sysctls, ulimits

**Security**:
- cap_add, cap_drop, privileged, security_opt
- read_only, group_add
- pid/ipc/cgroup namespace modes

**Devices**:
- devices, device_cgroup_rules
- gpus (if Podman supports)

**Health & Lifecycle**:
- healthcheck, restart (maps to systemd restart policies)
- stop_signal, stop_grace_period
- depends_on (maps to systemd After/Requires)

**Advanced**:
- init (RunInit), runtime
- user namespace (userns_mode)

---

## Out of Scope: Docker Swarm Orchestration

### ❌ Swarm-Only Features (REJECT in validation)

Features that require Docker Swarm's orchestrator:

**Multi-Node Orchestration**:
- `deploy.placement.*` - Node selection, constraints, preferences
- `deploy.mode: global` - Deploy to all nodes
- `deploy.replicas > 1` - Multi-instance scaling (unless using systemd templates)
- `deploy.endpoint_mode` - Service discovery (vip, dnsrr)

**Rolling Updates**:
- `deploy.update_config` - Rolling update strategies
- `deploy.rollback_config` - Rollback policies

**Swarm Networking**:
- `ports[].mode: ingress` - Swarm routing mesh load balancing
- (Use `mode: host` or no mode for Podman)

**Swarm Config/Secrets Store**:
- `configs` with `driver` field - Centralized Swarm config store
- `secrets` with `driver` field - Centralized Swarm secrets management
- `configs.external: true` with driver - References Swarm API
- `secrets.external: true` with driver - References Swarm API

**Service-Level Features**:
- `deploy.labels` - Labels on Swarm service entity (not containers)
- (Use top-level `labels` for container labels)

---

## Partial Support: Context-Dependent

### ⚠️ Features That Work Differently

**Configs & Secrets**:
- ✅ **Local sources** (file/content/environment) - Converted to bind mounts
- ❌ **Swarm driver** - Rejected with error
- Implementation: quad-ops converts local configs to bind mounts, rejects Swarm store

**Deploy Section**:
- ✅ **deploy.resources.limits** - Converted to Quadlet resource directives
- ✅ **deploy.resources.reservations** - Partially (limits work, guarantees don't)
- ❌ **deploy.placement/update_config/rollback_config** - Rejected
- ❌ **deploy.mode/replicas/endpoint_mode** - Rejected

**Restart Policy**:
- ✅ **Top-level `restart`** - Maps to systemd restart policies (preferred)
- ⚠️ **deploy.restart_policy** - Can work but designed for Swarm behavior

**Dependencies**:
- ✅ **depends_on** - Converted to systemd After/Requires
- ⚠️ **Limitations**: 
  - All conditions (service_started, service_healthy) map to same behavior
  - No health-gated startup (systemd doesn't support blocking on health)
  - Service ordering only, not health verification

**Scaling**:
- ❌ **deploy.replicas > 1** - Dynamic orchestration not supported
- ⚠️ **Workaround**: Could use systemd templates (service@1, service@2) but not implemented

---

## Validation Strategy

### Error on Swarm Features
Return validation error with clear message and alternatives:

```
ERROR: Swarm orchestration not supported
  - deploy.placement requires Docker Swarm
  - Alternative: Use Kubernetes, Nomad, or plain Podman pods
  
ERROR: Swarm config store not supported
  - configs.my_config has 'driver' field
  - Alternative: Use 'file' or 'content' source for local configs
```

### Warn on Unimplemented Standard Features
Return warning with workarounds:

```
Warning: service 'app' uses unsupported field 'volumes_from'
  - Alternative: Use named volumes instead
  
Warning: service 'db' uses 'stdin_open' and 'tty'
  - Interactive mode not practical in systemd units
  - Alternative: Use 'podman exec -it' for interactive sessions
```

---

## Compose Library Reference

**Source**: github.com/compose-spec/compose-go  
**Key Types**:
- `types.ServiceConfig` - Service-level configuration
- `types.DeployConfig` - Deploy section (mixed Swarm/standard)
- `types.ConfigObjConfig` / `types.SecretConfig` - Configs and secrets
- `types.FileObjectConfig` - Base for configs/secrets (has Driver field)

**Key Distinction**:
- `FileObjectConfig.Driver` - If set, it's Swarm store API (reject)
- `FileObjectConfig.File` - Local file path (bind mount)
- `FileObjectConfig.Content` - Inline content (write to temp file, bind mount)
- `FileObjectConfig.Environment` - Env var content (read, write, bind mount)

---

## Quadlet Capabilities

**Native Directives**: See [podman-systemd.unit(5)](https://docs.podman.io/en/latest/markdown/podman-systemd.unit.5.html)

Key native support (don't need PodmanArgs):
- Memory, PidsLimit, ShmSize
- AddHost, AddDevice, DNS, DNSSearch, DNSOption
- Sysctl, Ulimit
- GroupAdd, StopSignal, StopTimeout
- Volume, Tmpfs, Mount, PublishPort
- Network, NetworkAlias
- And many more...

**PodmanArgs Fallback**:
For features without native Quadlet directives:
- Namespace modes: --pid, --ipc, --cgroupns
- device_cgroup_rules: --device-cgroup-rule
- Any other podman run flags

---

## Implementation Priorities

### Phase 1: Cross-Platform Parity (P0-P1)
All standard Compose features work same on systemd and launchd:
- launchd missing: extra_hosts, dns, devices, tmpfs options
- Both platforms: stop_signal/stop_grace_period, group_add

### Phase 2: Common Standard Features (P2)
Features in 60%+ of real Compose files:
- shm_size, sysctls, ulimits
- pid/ipc/cgroup namespace modes
- Configs with local sources (file/content/environment)

### Phase 3: Validation & Documentation (P2-P3)
Prevent confusion:
- Error on Swarm features with clear messages
- Warn on unimplemented standard features
- README coverage matrix

### Phase 4: Edge Cases (P3)
Less common but valid:
- device_cgroup_rules
- x-podman-* extensions (if implementing)

---

## Example Validation Output

```bash
$ quad-ops validate docker-compose.yml

ERROR: Docker Swarm features not supported by quad-ops
  Service 'web':
    - deploy.placement.constraints requires Swarm orchestration
    - Alternative: Use Kubernetes for node placement

  Config 'app_config':
    - Driver 'consul' requires Swarm config store  
    - Alternative: Use 'file: ./config.json' for local configs

  Ports:
    - mode: ingress requires Swarm routing mesh
    - Alternative: Use 'mode: host' or remove mode

Warning: Some standard features not yet implemented
  Service 'app':
    - volumes_from: Use named volumes instead
    
  Service 'db':
    - stdin_open/tty: Interactive mode not practical in systemd
      Use 'podman exec -it' for interactive sessions

2 errors, 2 warnings
Validation failed. Fix errors to proceed.
```

---

## References

**Compose Specification**:
- https://github.com/compose-spec/compose-spec
- Configs: https://github.com/compose-spec/compose-spec/blob/main/08-configs.md
- Secrets: https://github.com/compose-spec/compose-spec/blob/main/09-secrets.md
- Deploy: https://github.com/compose-spec/compose-spec/blob/main/deploy.md

**Compose Library**:
- https://github.com/compose-spec/compose-go
- types.go: ServiceConfig, DeployConfig, FileObjectConfig

**Podman**:
- Quadlet: https://docs.podman.io/en/latest/markdown/podman-systemd.unit.5.html
- podman run: https://docs.podman.io/en/latest/markdown/podman-run.1.html

**Docker Swarm** (for understanding what to avoid):
- https://docs.docker.com/engine/swarm/
- Config API: https://docs.docker.com/engine/swarm/configs/
- Secrets API: https://docs.docker.com/engine/swarm/secrets/
